<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pitch Polling System</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" class="p-6">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Pitch Polling System</h1>
      <p class="text-gray-600 mb-6">Vote for the best startup pitch. You can only vote once!</p>
      
      <div id="status" class="mb-6"></div>
      <div id="totalVotes" class="mb-6 text-gray-600"></div>
      <div id="pitches" class="space-y-4"></div>
      <div id="tip" class="mt-6"></div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let hasVoted = false;
    let votedPitchId = null;
    let voterId = localStorage.getItem('voterId') || generateVoterId();

    function generateVoterId() {
      const id = 'voter_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('voterId', id);
      return id;
    }

    async function loadPitches() {
      try {
        const res = await fetch(`${API_BASE}/api/pitches`);
        const data = await res.json();
        
        checkVotingStatus();
        renderPitches(data.pitches);
      } catch (error) {
        console.error('Error loading pitches:', error);
        document.getElementById('pitches').innerHTML = '<p class="text-red-600">Failed to load pitches</p>';
      }
    }

    function checkVotingStatus() {
      const voted = localStorage.getItem('hasVoted');
      const pitchId = localStorage.getItem('votedPitchId');
      if (voted === 'true') {
        hasVoted = true;
        votedPitchId = Number(pitchId);
        showStatus();
      }
    }

    function showStatus() {
      document.getElementById('status').innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <p class="text-green-800 font-medium">‚úì Thank you for voting! Your vote has been recorded.</p>
        </div>
      `;
    }

    async function vote(pitchId) {
      if (hasVoted) return;

      try {
        const res = await fetch(`${API_BASE}/api/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pitchId, voterId })
        });

        const data = await res.json();

        if (res.status === 403) {
          hasVoted = true;
          votedPitchId = data.votedPitchId;
          localStorage.setItem('hasVoted', 'true');
          localStorage.setItem('votedPitchId', data.votedPitchId);
          showStatus();
          loadPitches();
          return;
        }

        if (!res.ok) throw new Error(data.error);

        hasVoted = true;
        votedPitchId = pitchId;
        localStorage.setItem('hasVoted', 'true');
        localStorage.setItem('votedPitchId', pitchId);
        
        showStatus();
        renderPitches(data.pitches);
      } catch (error) {
        console.error('Error voting:', error);
        alert('Failed to submit vote. Please try again.');
      }
    }

    function renderPitches(pitches) {
      const totalVotes = pitches.reduce((sum, p) => sum + p.votes, 0);
      const sorted = [...pitches].sort((a, b) => b.votes - a.votes);

      document.getElementById('totalVotes').innerHTML = `
        <span class="font-medium">üë• ${totalVotes} total votes</span>
      `;

      document.getElementById('pitches').innerHTML = sorted.map((pitch, index) => {
        const percentage = totalVotes > 0 ? (pitch.votes / totalVotes * 100).toFixed(1) : 0;
        const isVoted = pitch.id === votedPitchId;

        return `
          <div class="border-2 ${isVoted ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'} rounded-xl p-5">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  ${hasVoted && index === 0 && pitch.votes > 0 ? '<span class="bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded">üèÜ LEADING</span>' : ''}
                  <h3 class="text-xl font-semibold text-gray-800">${pitch.title}</h3>
                </div>
                <p class="text-gray-600 mb-3">${pitch.description}</p>
                
                ${hasVoted ? `
                  <div class="space-y-2">
                    <div class="flex items-center gap-3">
                      <div class="flex-1 bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="bg-indigo-600 h-full rounded-full transition-all" style="width: ${percentage}%"></div>
                      </div>
                      <span class="text-sm font-medium text-gray-700 min-w-[60px]">${percentage}%</span>
                    </div>
                    <p class="text-sm text-gray-500">${pitch.votes} ${pitch.votes === 1 ? 'vote' : 'votes'}</p>
                  </div>
                ` : ''}
              </div>
              
              <button
                onclick="vote(${pitch.id})"
                ${hasVoted ? 'disabled' : ''}
                class="${hasVoted ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700'} px-6 py-3 rounded-lg font-medium transition-all"
              >
                üëç Vote
              </button>
            </div>
          </div>
        `;
      }).join('');

      if (!hasVoted) {
        document.getElementById('tip').innerHTML = `
          <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-blue-800 text-sm">üí° <strong>Tip:</strong> Choose wisely! You can only vote once.</p>
          </div>
        `;
      }
    }

    loadPitches();
  </script>
</body>
</html>